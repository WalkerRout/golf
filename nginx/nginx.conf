worker_processes auto;

events {
  worker_connections 1024;
}

http {
  # for websockets / SSE
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  upstream app {
    server server:3000;
    keepalive 32;
  }

  # Internal listener for cloudflared -> nginx (HTTP only)
  server {
    listen 80;
    server_name _;

    # cloudflare handles tls termination...

    location / {
      proxy_pass http://app;
      proxy_http_version 1.1;

      # pass through real client info from Cloudflare
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $http_cf_connecting_ip;
      proxy_set_header X-Forwarded-For   $http_cf_connecting_ip;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-Host  $host;

      # websockets / keep-alive
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;

      proxy_read_timeout 60s;
    }
  }
}
